<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gracias</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:28px}
    .box{max-width:720px;margin:0 auto;border:1px solid #e9e9e9;border-radius:14px;padding:18px}
  </style>
</head>
<body>
  <div class="box">
    <h1>Pago recibido ✅</h1>
    <p>En unos minutos recibirás un email con tu enlace de acceso.</p>
    <p>Si no te llega, revisa spam/promociones.</p>
    <p><a href="/">Volver al inicio</a></p>
  </div>
<div id="token-status" style="margin-top:14px"></div>
<div id="token-link" style="margin-top:10px"></div>

<script>
  (async function(){
    const params = new URLSearchParams(window.location.search);
    const session_id = params.get("session_id");

    const statusEl = document.getElementById("token-status");
    const linkEl = document.getElementById("token-link");

    if(!session_id){
      statusEl.textContent = "Falta session_id. Vuelve a la página de pago.";
      return;
    }

    statusEl.textContent = "Confirmando pago y generando tu acceso…";

    try{
      const res = await fetch("/.netlify/functions/get-token?session_id=" + encodeURIComponent(session_id));
      const data = await res.json();

      if(!res.ok || !data.token){
        statusEl.textContent = "Aún no está listo. Espera 5 segundos y recarga esta página.";
        return;
      }

      const url = window.location.origin + "/?token=" + data.token;

      statusEl.textContent = "¡Listo! Aquí tienes tu acceso:";
      linkEl.innerHTML = `
        <a class="btn primary" href="${url}">Ir a mi panel</a>
        <div style="margin-top:8px; font-size:12px; opacity:.8">
          (Guarda este enlace: es tu acceso sin registro)
        </div>
      `;
    } catch(e){
      statusEl.textContent = "Error consultando el token. Recarga en unos segundos.";
    }
  })();
</script>

</body>
</html>
